<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puzzle</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#0a1930; --bg2:#00010f; --c1:#eaf2ff; --c2:#b8d0ff; --c3:#a8cfff; --c4:#66aaff;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Outfit',sans-serif;
    color:var(--c1);
    background:radial-gradient(circle at 25% 25%, var(--bg1), var(--bg2) 80%);
    min-height:100vh;
  }

  nav{
    position:fixed; top:0; left:0; width:100%;
    display:flex; justify-content:center; gap:40px; padding:18px 0;
    background:rgba(10,15,40,.35); backdrop-filter:blur(12px);
    border-bottom:1px solid rgba(255,255,255,.05); z-index:1000;
    box-shadow:0 0 20px rgba(102,170,255,.15);
  }
  nav a{
    color:#b8d0ff; text-decoration:none; font-weight:400; transition:.3s;
    letter-spacing:1px; font-size:.95em; position:relative;
  }
  nav a::after{
    content:""; position:absolute; bottom:-5px; left:0; width:0; height:2px;
    background:#66aaff; transition:width .3s;
  }
  nav a:hover::after{ width:100%; }
  nav a:hover{ color:#66aaff; text-shadow:0 0 8px #66aaff; }

  .wrap{max-width:1200px;margin:0 auto;padding:130px 6% 40px}
  header.hd{text-align:center;margin-bottom:18px}
  header.hd h1{color:#89c4ff;text-shadow:0 0 10px rgba(102,170,255,.25)}
  header.hd p{color:#c9d8ff;opacity:.95}

  .topbar{
    margin:18px 0 14px;
    display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between
  }
  .stat{
    display:flex;gap:14px;flex-wrap:wrap;color:#c8d6ff
  }
  .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06)}
  .btn{
    display:inline-block;padding:10px 18px;border-radius:12px;
    text-decoration:none;border:1px solid rgba(255,255,255,.15);
    color:var(--c1);background:rgba(255,255,255,.06);
    transition:transform .2s, box-shadow .2s, background .2s; cursor:pointer;
    box-shadow:0 0 10px rgba(102,170,255,.25)
  }
  .btn:hover{transform:translateY(-2px);box-shadow:0 0 18px rgba(102,170,255,.35)}
  .btn.main{background:linear-gradient(90deg,#003366,#0055aa);border:none}
  .btn.main:hover{background:linear-gradient(90deg,#004080,#0077ff)}

  .board-wrap{
    display:grid;grid-template-columns:1fr 320px;gap:18px;
  }
  @media (max-width:980px){ .board-wrap{grid-template-columns:1fr} }

  .board{
    aspect-ratio:1/1; width:100%;
    background:#02040c;border-radius:20px;
    border:1px solid rgba(255,255,255,.1);
    box-shadow:0 0 22px rgba(102,170,255,.15);
    display:grid; overflow:hidden; position:relative;
  }
  .tile{
    position:relative; user-select:none;
    background-repeat:no-repeat; background-size:var(--bgW) var(--bgH);
    border:1px solid rgba(255,255,255,.06);
    transition: box-shadow .15s;
  }
  .tile.dragging{ opacity:.9; box-shadow:0 0 18px rgba(102,170,255,.5) inset; }
  .tile.over{ outline:2px dashed rgba(102,170,255,.8); }

  .side{
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
    border-radius:20px; padding:16px; height:fit-content;
    box-shadow:0 0 22px rgba(102,170,255,.15);
  }
  .side h3{color:var(--c3);margin-bottom:8px}
  .thumb{
    border:1px solid rgba(255,255,255,.1); border-radius:12px; overflow:hidden;
    background:#02040c; margin-bottom:10px
  }
  .thumb img{width:100%;display:block}
  .help{font-size:.9em;color:#7a8cb3}
  .win{
    position:absolute; inset:0; display:none; place-items:center;
    background:rgba(2,4,12,.55); backdrop-filter: blur(4px);
  }
  .win .win-box{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15);
    border-radius:20px; padding:20px; text-align:center; width:min(520px,90vw);
    box-shadow:0 0 24px rgba(102,170,255,.35);
  }
  .win h2{color:#89c4ff;margin-bottom:8px}
   footer{text-align:center;padding:45px 0;color:#7a8cb3;font-size:.9em;border-top:1px solid rgba(255,255,255,.05);background:#02040c}
</style>
</head>
<body>

<nav>
  <a href="/inicio">Home</a>
  <a href="/pronostico">Forecast</a>
  <a href="#">Schedule</a>
  <a href="/comparar">Compare Places</a>
  <a href="/educacion">Education</a>
  <a href="/juego">Mini Games</a>
  <a href="/login">Login</a>
  <a href="/perfil">My Profile</a>
  <a href="/logout" style="color:#ff6b6b;">Logout</a>
</nav>

<div class="wrap">
  <header class="hd">
    <h1>Puzzle</h1>
    <p>Drag the pieces to complete the image.</p>
  </header>

  <div class="topbar">
    <div class="stat">
      <span class="badge" id="dimBadge">0√ó0</span>
      <span class="badge">Moves: <b id="moves">0</b></span>
      <span class="badge">Time: <b id="time">00:00</b></span>
    </div>
    <div class="actions">
      <button class="btn" id="btnReiniciar">Restart</button>
      <a class="btn main" href="/juego/personalizado">‚Üê Back</a>
    </div>
  </div>

  <div class="board-wrap">
    <div class="board" id="board"></div>

    <aside class="side">
      <h3>Preview</h3>
      <div class="thumb"><img id="thumb" alt="Preview"></div>
      <p class="help">Tip: If the pieces don't fit perfectly, try enlarging your browser window to make the board bigger.</p>
    </aside>
  </div>
</div>

<div class="win" id="win">
  <div class="win-box">
    <h2>Completed! üéâ</h2>
    <p>Time: <b id="wTime">00:00</b> ¬∑ Moves: <b id="wMoves">0</b></p>
    <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
      <button class="btn" id="btnAgain">Play Again</button>
      <a class="btn main" href="/juego/personalizado">Back</a>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
function getHashParam(name){
  const m = (location.hash||'').match(new RegExp(name+'=([^&]+)'));
  return m ? decodeURIComponent(m[1]) : null;
}
function bestFactorPair(n){
  n = Math.max(3, Math.min(60, n|0));
  let bestR=1, bestC=n, bestDiff=n-1, exact=true;
  for (let r=1; r<=Math.sqrt(n); r++){
    if (n % r === 0){
      const c = n/r;
      if (Math.abs(c - r) < bestDiff){ bestDiff = Math.abs(c-r); bestR=r; bestC=c; }
    }
  }
  if (bestR*bestC !== n){
    exact = false;
    bestR = Math.floor(Math.sqrt(n));
    bestC = Math.ceil(n / bestR);
  }
  return {rows:bestR, cols:bestC, exact};
}

const imgData = getHashParam('img') || sessionStorage.getItem('rompecabezas_imagen');
const nPieces = Number(getHashParam('n')) || Number(sessionStorage.getItem('rompecabezas_piezas')) || 16;
if (!imgData){ alert("No image found. Please go back and choose one."); location.href="./inicio.html"; }

$('#thumb').src = imgData;

const board = $('#board');
const dimBadge = $('#dimBadge');
const movesEl = $('#moves');
const timeEl = $('#time');

let timer=null, seconds=0, moves=0;
let rows=0, cols=0;
let order=[];        
let solvedOrder=[];  
let tiles=0;

function startTimer(){
  if (timer) clearInterval(timer);
  seconds = 0;
  timeEl.textContent = "00:00";
  timer = setInterval(()=>{
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    timeEl.textContent = `${m}:${s}`;
  },1000);
}
function stopTimer(){ if (timer){ clearInterval(timer); timer=null; } }

function createBoard(){
  const f = bestFactorPair(nPieces);
  rows = f.rows; cols = f.cols;
  tiles = rows*cols;

  board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  board.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  dimBadge.textContent = `${rows}√ó${cols}`;

  solvedOrder = Array.from({length:tiles}, (_,i)=>i);
  order = shuffle([...solvedOrder]);

  renderTiles();
  startTimer();
}

function shuffle(a){
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  if (a.every((v,i)=>v===i)) return shuffle(a);
  return a;
}

function renderTiles(){
  board.innerHTML = "";
  const bgW = `${cols*100}%`, bgH = `${rows*100}%`;
  board.style.setProperty('--bgW', bgW);
  board.style.setProperty('--bgH', bgH);

  order.forEach((pieceIdx, pos)=>{
    const pieceR = Math.floor(pieceIdx / cols);
    const pieceC = pieceIdx % cols;

    const el = document.createElement('div');
    el.className = 'tile';
    el.draggable = true;
    el.dataset.correct = String(pieceIdx);
    el.dataset.pos = String(pos);
    el.style.backgroundImage = `url(${imgData})`;
    el.style.backgroundPosition = `${(pieceC/(cols-1))*100}% ${(pieceR/(rows-1))*100}%`;

    el.addEventListener('dragstart', ev=>{
      ev.dataTransfer.setData('text/plain', String(pos));
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
    el.addEventListener('dragover', ev=>{ ev.preventDefault(); el.classList.add('over'); });
    el.addEventListener('dragleave', ()=> el.classList.remove('over'));
    el.addEventListener('drop', ev=>{
      ev.preventDefault();
      el.classList.remove('over');
      const fromPos = Number(ev.dataTransfer.getData('text/plain'));
      const toPos = pos;
      if (fromPos===toPos) return;
      [order[fromPos], order[toPos]] = [order[toPos], order[fromPos]];
      moves++; movesEl.textContent = moves;
      renderTiles();
      checkWin();
    });

    board.appendChild(el);
  });
}

function checkWin(){
  const ok = order.every((v,i)=> v===i);
  if (!ok) return;
  stopTimer();
  $('#wTime').textContent = timeEl.textContent;
  $('#wMoves').textContent = String(moves);
  $('#win').style.display = 'grid';
}

$('#btnReiniciar').addEventListener('click', ()=>{
  moves = 0; movesEl.textContent = "0";
  startTimer();
  order = shuffle([...solvedOrder]);
  renderTiles();
});

$('#btnAgain').addEventListener('click', ()=>{
  $('#win').style.display = 'none';
  $('#btnReiniciar').click();
});

createBoard();
</script>

<footer>
  ¬© 2025 EcoWheater | Designed with üíô for the planet
</footer>

</body>
</html>
